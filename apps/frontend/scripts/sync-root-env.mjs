import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const ROOT_ENV_PATH = path.resolve(__dirname, "..", "..", "..", ".env.local");
const FRONTEND_ENV_PATH = path.resolve(__dirname, "..", ".env.local");

const REQUIRED_KEYS = ["NEXT_PUBLIC_API_BASE_URL"];
const OPTIONAL_KEYS = ["NEXT_PUBLIC_MOCK_API"];

function parseDotenv(contents) {
  const result = {};

  for (const rawLine of contents.split(/\r?\n/)) {
    const line = rawLine.trim();
    if (!line || line.startsWith("#")) continue;

    const equalsIdx = line.indexOf("=");
    if (equalsIdx <= 0) continue;

    const key = line.slice(0, equalsIdx).trim();
    let value = line.slice(equalsIdx + 1).trim();

    if (
      (value.startsWith('"') && value.endsWith('"')) ||
      (value.startsWith("'") && value.endsWith("'"))
    ) {
      value = value.slice(1, -1);
    }

    result[key] = value;
  }

  return result;
}

function formatFrontendEnv(values) {
  const lines = [
    "# Generated by apps/frontend/scripts/sync-root-env.mjs",
    "# Source: ../../.env.local",
    "",
  ];

  for (const key of REQUIRED_KEYS) {
    lines.push(`${key}=${values[key]}`);
  }

  for (const key of OPTIONAL_KEYS) {
    if (values[key]) {
      lines.push(`${key}=${values[key]}`);
    }
  }

  lines.push("");
  return lines.join("\n");
}

function main() {
  if (!fs.existsSync(ROOT_ENV_PATH)) {
    console.error(`[sync-root-env] Missing root env file: ${ROOT_ENV_PATH}`);
    process.exit(1);
  }

  const rootEnv = parseDotenv(fs.readFileSync(ROOT_ENV_PATH, "utf8"));

  const missingKeys = REQUIRED_KEYS.filter((k) => !rootEnv[k]);
  if (missingKeys.length > 0) {
    console.error(
      `[sync-root-env] Missing required key(s) in root .env.local: ${missingKeys.join(
        ", ",
      )}`,
    );
    process.exit(1);
  }

  fs.writeFileSync(FRONTEND_ENV_PATH, formatFrontendEnv(rootEnv), "utf8");
  console.log(`[sync-root-env] Wrote ${FRONTEND_ENV_PATH}`);
}

main();
